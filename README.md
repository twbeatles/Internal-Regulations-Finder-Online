# 📚 사내 규정검색기 온라인 서버버전 v1.3

> AI 기반 하이브리드 검색 시스템을 갖춘 사내 규정 검색 웹 서버

## ✨ 주요 기능

| 기능 | 설명 |
|------|------|
| 🔍 **하이브리드 검색** | Vector Search + BM25 결합으로 높은 검색 정확도 |
| 🤖 **AI 모델 선택** | SNU SBERT, BM-K Simal, JHGan SBERT 중 선택 가능 |
| 📄 **다양한 문서 형식** | TXT, DOCX, PDF 파일 지원 |
| 📥 **원본 파일 다운로드** | 검색 결과에서 원본 규정 파일 직접 다운로드 |
| ⭐ **북마크 기능** | 자주 참조하는 검색 결과 저장 |
| 🔎 **검색 필터** | 특정 파일에서만 검색 가능 |
| 📊 **검색 정렬** | 관련도순/파일명순/길이순 정렬 |
| 📈 **검색 통계** | 인기 검색어, 파일 통계 조회 |
| 🎨 **다크/라이트 테마** | 사용자 선호에 맞는 테마 전환 |
| 🔒 **관리자 비밀번호** | 관리자 페이지 접근 보호 |
| 📊 **실시간 로그** | GUI에서 서버 상태 및 오류 확인 |
| 🖥️ **시스템 트레이** | 백그라운드 실행 및 자동 시작 |
| 🌐 **포트 설정** | GUI에서 서버 포트 변경 가능 |
| ⚡ **다중 사용자 지원** | Rate Limiting, 동시 검색 관리, 요청 큐 시스템 |

---

## 🚀 v1.3 주요 업데이트 (2024-12-19)

### 다중 사용자 최적화
- **Rate Limiter**: IP당 분당 60회 요청 제한으로 서버 보호
- **Search Queue**: 최대 10개 동시 검색 관리 (세마포어 기반)
- **Waitress 스레드**: 8개 → 16개로 증가
- **병렬 문서 처리**: ThreadPoolExecutor로 파일 추출 병렬화

### 안정성 개선
- **파일 작업 락**: 동시 업로드/삭제 시 race condition 방지
- **중복 파일명 처리**: 업로드 시 자동으로 `파일_1.ext` 형식 변환
- **에러 복구**: 일부 파일 실패해도 나머지 계속 처리
- **API 재시도**: 503 오류 시 클라이언트 자동 재시도 (최대 3회)

### 버그 수정
- 중복된 에러 핸들러 제거 (27줄)
- 요청 타임아웃 최적화 (60s → 30s)
- 검색 캐시 크기 증가 (100 → 200)

---

## 🛠️ 설치

### 요구 사항

- Python 3.10 이상
- Windows 10/11

### 패키지 설치

```bash
pip install -r requirements.txt
```

### 주요 의존성

| 패키지 | 용도 |
|--------|------|
| Flask | 웹 서버 프레임워크 |
| PyQt6 | GUI 애플리케이션 |
| torch | AI 모델 연산 |
| langchain-huggingface | 임베딩 모델 |
| faiss-cpu | 벡터 검색 인덱스 |
| waitress | 프로덕션 WSGI 서버 |

---

## 🚀 실행

### 개발 모드

```bash
python server_gui.py
```

### 최소화 시작

```bash
python server_gui.py --minimized
```

---

## 📦 빌드 (패키징)

```bash
pyinstaller server_gui.spec
```

빌드 결과: `dist/사내규정검색기/사내규정검색기.exe`

---

## 💻 사용법

### 1. 서버 시작

GUI에서 서버가 자동으로 시작됩니다. 상태바에서 진행 상황을 확인하세요.

### 2. 웹 접속

| 페이지 | URL |
|--------|-----|
| 검색 페이지 | http://localhost:8080 |
| 관리자 페이지 | http://localhost:8080/admin |

### 3. 검색 옵션

| 옵션 | 설명 |
|------|------|
| **결과 개수** | 5, 10, 20개 선택 |
| **파일 필터** | 특정 파일에서만 검색 |
| **정렬** | 관련도순, 파일명순, 길이순 |
| **하이브리드 검색** | Vector + BM25 결합 검색 |

### 4. 북마크 사용

1. 검색 결과에서 ⭐ 버튼 클릭
2. 북마크는 브라우저 로컬스토리지에 저장
3. 같은 브라우저에서 언제든 확인 가능

### 5. AI 모델 변경

1. 관리자 페이지 → "AI 모델 설정" 섹션
2. 원하는 모델 선택:
   - **SNU SBERT (고성능)**: 최고 정확도 (기본)
   - **BM-K Simal (균형)**: 성능과 속도의 균형
   - **JHGan SBERT (빠름)**: 빠른 응답 속도
3. "변경 적용" 클릭

---

## 🔌 API 엔드포인트

### 검색 API

| 메서드 | 경로 | 설명 |
|--------|------|------|
| POST | `/api/search` | 규정 검색 (filter_file, sort_by 지원) |
| GET | `/api/search/history` | 검색 히스토리 |
| GET | `/api/search/suggest` | 검색어 자동완성 |
| GET | `/api/stats/search` | 검색 통계 (인기 검색어 등) |

### 파일 API

| 메서드 | 경로 | 설명 |
|--------|------|------|
| POST | `/api/upload` | 파일 업로드 (병렬 처리) |
| GET | `/api/files` | 파일 목록 |
| GET | `/api/files/names` | 파일명 목록 (필터용) |
| GET | `/api/files/{name}/download` | 파일 다운로드 |
| GET | `/api/files/{name}/preview` | 파일 미리보기 |
| DELETE | `/api/files/{name}` | 파일 삭제 (스레드 안전) |

### 관리 API

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | `/api/status` | 서버 상태 (CPU/메모리 포함) |
| GET | `/api/health` | 헬스체크 |
| GET | `/api/models` | 모델 목록 |
| POST | `/api/models` | 모델 변경 |
| POST | `/api/admin/auth` | 관리자 인증 |

---

## ⚙️ 설정

### 관리자 비밀번호

GUI의 **"🔑 관리자 비밀번호 설정"** 버튼에서 설정

### 포트 설정

GUI의 **"🌐 포트 변경"** 버튼에서 설정 (기본: 8080)

### 자동 시작

**"Windows 시작 시 자동 실행"** 체크박스 활성화

### 동시성 설정 (AppConfig)

| 설정 | 기본값 | 설명 |
|------|--------|------|
| MAX_WORKERS | 8 | 문서 처리 병렬 스레드 수 |
| REQUEST_TIMEOUT | 30 | 요청 타임아웃 (초) |
| SEARCH_CACHE_SIZE | 200 | 검색 결과 캐시 크기 |
| MAX_CONCURRENT_SEARCHES | 10 | 최대 동시 검색 수 |
| RATE_LIMIT_PER_MINUTE | 60 | IP당 분당 최대 요청 수 |

---

## 🐛 트러블슈팅

| 문제 | 해결 방법 |
|------|----------|
| 서버 준비되지 않음 | 로그에서 오류 확인, 모델 로드 대기 |
| 파일 업로드 실패 | 지원 형식 확인 (.txt, .docx, .pdf) |
| 모델 변경 실패 | 인터넷 연결 확인, 디스크 공간 확인 |
| 검색 결과 없음 | 검색어 변경, 하이브리드 검색 활성화 |
| 요청이 너무 많습니다 (429) | Rate Limit 초과, 60초 후 재시도 |
| 서버가 바쁩니다 (503) | 동시 검색 제한 초과, 자동 재시도됨 |

---

## 📁 폴더 구조

```
사내 규정검색기 온라인 서버버전/
├── server.py          # Flask 서버 및 검색 엔진
├── server_gui.py      # PyQt6 GUI 애플리케이션
├── server_gui.spec    # PyInstaller 빌드 설정
├── requirements.txt   # 패키지 의존성
├── templates/         # HTML 템플릿
├── static/            # CSS, JavaScript
├── uploads/           # 업로드된 규정 파일
├── config/            # 설정 파일
└── models/            # AI 모델 캐시
```

---

## 🔄 버전 히스토리

### v1.3 (2025-12-19)
- ⚡ **다중 사용자 최적화**
  - Rate Limiter (IP당 분당 60회 제한)
  - Search Queue (최대 10개 동시 검색)
  - Waitress 스레드 8→16개 증가
- 🚀 **병렬 문서 처리**
  - ThreadPoolExecutor로 파일 추출 8배속
  - 파일당 60초 타임아웃으로 멈춤 방지
- 🔒 **안정성 개선**
  - 파일 작업 락으로 race condition 방지
  - 중복 파일명 자동 처리
  - API 자동 재시도 (503 오류)
- 🐛 **버그 수정**
  - 중복 에러 핸들러 제거
  - 요청 타임아웃 최적화

### v1.2 (2025-12-18)
- ⭐ 북마크 기능 추가 (로컬스토리지 기반)
- 🔎 파일별 검색 필터 기능
- 📊 검색 결과 정렬 옵션 (관련도/파일명/길이순)
- 📈 검색 통계 API (`/api/stats/search`)
- 결과 개수 옵션 확장 (5/10/20개)
- 검색 UI 개선

### v1.1 (2025-12-18)
- AI 모델 선택 기능 (3종)
- 원본 파일 다운로드
- 관리자 페이지 보안 강화
- 포트 설정 기능

### v1.0
- 초기 릴리스
- 하이브리드 검색 (Vector + BM25)
- 파일 업로드 및 관리
- 시스템 트레이 지원

---

## 📄 라이선스

내부 사용 목적으로 개발되었습니다.
